<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wirepas Single-MCU SDK: inventory_app_tag/app.c</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Wirepas Single-MCU SDK"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../small_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Wirepas Single-MCU SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d3/d2f/inventory_app_tag_2app_8c-example.html','../../');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">inventory_app_tag/app.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/* Copyright 2019 Wirepas Ltd. All Rights Reserved.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * See file LICENSE.txt for full license details.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * \file    app.c</span></div><div class="line"><span class="comment"> * \brief   App for sending directed-advertiser packets</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dc/d65/api_8h.html">api.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../df/d2e/node__configuration_8h.html">node_configuration.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../de/df7/time_8h.html">time.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dd/ddc/app__scheduler_8h.html">app_scheduler.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d1/d79/random_8h.html">random.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/d6a/power_8h.html">power.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;../inventory_app_router/common.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define NODE_DEFAULT_ROLE \</span></div><div class="line"><span class="preprocessor">    app_lib_settings_create_role(APP_LIB_SETTINGS_ROLE_ADVERTISER,0)</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#define MAX_BEACONS 1</span></div><div class="line"><span class="preprocessor">#define MAX_SCAN_RETRY 4    // max. number of scans in one iteration</span></div><div class="line"><span class="preprocessor">#define MAX_SCAN_FAILURES (2 * MAX_SCAN_RETRY) // max. number of failed scans</span></div><div class="line"><span class="preprocessor">#define SCAN_RAND_MS 250 // scan start randomization window</span></div><div class="line"><span class="preprocessor">#define SEND_RAND_MS 100 // send start randomization window</span></div><div class="line"><span class="preprocessor">#define MAX_SEND_RETRY 2 // max. number of send retires in one iteration</span></div><div class="line"></div><div class="line"><span class="comment">// Period to send advertisement</span></div><div class="line"><span class="preprocessor">#define ADV_PERIOD_MS   (ADVERTISER_RATE_SEC * 1000)</span></div><div class="line"><span class="preprocessor">#define MAX_SCAN_TIME_MS (NETWORK_BEACON_RATE_US / 1000)</span></div><div class="line"></div><div class="line"><span class="comment">//Timeouts</span></div><div class="line"><span class="preprocessor">#define TIMEOUT_SCAN_MS 400</span></div><div class="line"><span class="preprocessor">#define TIMEOUT_SCAN_RETRY_MS 50</span></div><div class="line"><span class="preprocessor">#define TIMEOUT_SCAN_END_MS 2000</span></div><div class="line"><span class="preprocessor">#define TIMEOUT_SEND_DATA_MS 2000</span></div><div class="line"><span class="preprocessor">#define TIMEOUT_SEND_CONFIRM_MS 6000</span></div><div class="line"></div><div class="line"><span class="comment">//#define FORCE_NETWORK_CONFIG</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span>{</div><div class="line">    IDLE = 0,</div><div class="line">    SCAN = 1,</div><div class="line">    SCAN_END = 2,</div><div class="line">    SEND_DATA = 3,</div><div class="line">    SEND_CONFIRM = 4,</div><div class="line">    ACK = 5,</div><div class="line">    MAX_STATE = 6</div><div class="line">} state_res_e;</div><div class="line"></div><div class="line"><span class="keyword">static</span> uint32_t advertiser_task(<span class="keywordtype">void</span>);</div><div class="line"><span class="keyword">static</span> <a class="code" href="../../d2/dbd/data_8h.html#ab53b6510f8ecb4a1621c905c15855164">app_lib_data_send_res_e</a> res __attribute__((unused));</div><div class="line"></div><div class="line"><span class="comment">/* Advertiser m_state data */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    <span class="keywordtype">bool</span> done;</div><div class="line">    <span class="keywordtype">bool</span> success;</div><div class="line">    uint32_t timeout_ms;</div><div class="line">    uint32_t start_hp;</div><div class="line">    uint32_t end_hp;</div><div class="line">} adv_tag_state_data_t;</div><div class="line"></div><div class="line"><span class="comment">/* Advertiser task internal data */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    uint8_t run;</div><div class="line">    uint8_t current;</div><div class="line">    uint8_t scan_failures;</div><div class="line">    uint8_t scan_count;</div><div class="line">    uint8_t send_count;</div><div class="line">    uint32_t startup_ms;</div><div class="line">    <a class="code" href="../../d2/dbd/data_8h.html#a3a8535cade8b081cfee20f0f4b9b0e65">app_lib_data_tracking_id_t</a> tracking_id;</div><div class="line">    adv_tag_state_data_t data[MAX_STATE];</div><div class="line">} adv_tag_state_t;</div><div class="line"></div><div class="line"><span class="comment">/* Network beacon data */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span>{</div><div class="line">    uint8_t requested;</div><div class="line">    uint8_t count;</div><div class="line">    uint8_t target;</div><div class="line">    uint8_t retry;</div><div class="line">    uint32_t time_hp[MAX_BEACONS];</div><div class="line">    <a name="_a0"></a><a class="code" href="../../db/d3b/state_8h.html#d7/dc8/structapp__lib__state__beacon__rx__t">app_lib_state_beacon_rx_t</a> data[MAX_BEACONS];</div><div class="line">} beacon_t;</div><div class="line"></div><div class="line"><span class="comment">/* Advertiser node settings */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span>{</div><div class="line">    uint32_t period_ms;</div><div class="line">    uint8_t otap_seq;</div><div class="line">    uint8_t max_beacons;</div><div class="line">    uint32_t max_scan_time_ms;</div><div class="line">    uint32_t period_phase_ms;</div><div class="line">} adv_tag_settings_t;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Global variables</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> adv_tag_state_t m_state;</div><div class="line"><span class="keyword">static</span> beacon_t m_beacons;</div><div class="line"><span class="keyword">static</span> uint8_t m_ack_data[<span class="keyword">sizeof</span>(adv_tag_app_cfg_t)];</div><div class="line"></div><div class="line"><span class="keyword">static</span> adv_tag_settings_t m_settings = {</div><div class="line">    .period_ms = ADV_PERIOD_MS,</div><div class="line">    .otap_seq = 0,</div><div class="line">    .max_beacons = MAX_BEACONS,</div><div class="line">    .max_scan_time_ms = MAX_SCAN_TIME_MS,</div><div class="line">    .period_phase_ms = 0</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a name="_a1"></a><a class="code" href="../../d2/dbd/data_8h.html#d7/d10/structapp__lib__data__to__send__t">app_lib_data_to_send_t</a> m_adv_to_send =</div><div class="line">{</div><div class="line">    .<a name="a2"></a><a class="code" href="../../d2/dbd/data_8h.html#abe388560a25c7690c48b6f3e20a32278">dest_address</a> = <a name="a3"></a><a class="code" href="../../d2/d39/app_8h.html#a2fe888af6a0b27cd2455757d0823a313a1d64d118fbd3df68c8ab52ce6fd94c6c">APP_ADDR_ANYSINK</a>,</div><div class="line">    .src_endpoint = <a name="a4"></a><a class="code" href="../../d8/d4b/advertiser_8h.html#a3ba6484f531d16b8d01bcfd1705760d7">DIRADV_EP_SRC_DATA</a>,</div><div class="line">    .dest_endpoint = <a name="a5"></a><a class="code" href="../../d8/d4b/advertiser_8h.html#a934065336770726e2ca8b206d00940c0">DIRADV_EP_DEST</a>,</div><div class="line">    .flags = 1,</div><div class="line">    .tracking_id = <a name="a6"></a><a class="code" href="../../d2/dbd/data_8h.html#a6a2e44ccee2f7e4393d38f9072bd1841">APP_LIB_DATA_NO_TRACKING_ID</a>,</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> sentDataCb(<span class="keyword">const</span> <a name="_a7"></a><a class="code" href="../../d2/dbd/data_8h.html#d6/de0/structapp__lib__data__sent__status__t">app_lib_data_sent_status_t</a> * status)</div><div class="line">{</div><div class="line">  <span class="keywordflow">if</span> (status-&gt;<a name="a8"></a><a class="code" href="../../d2/dbd/data_8h.html#a7f43082a8111a69a9189426ea4fb9987">tracking_id</a> == m_state.tracking_id)</div><div class="line">  {</div><div class="line">    m_state.data[SEND_CONFIRM].done = <span class="keyword">true</span>;</div><div class="line">    m_state.data[SEND_CONFIRM].success = status-&gt;<a name="a9"></a><a class="code" href="../../d2/dbd/data_8h.html#a7960f9c558f9ee2c3d4a8fdea096fb56">success</a>;</div><div class="line">    <span class="comment">// notify the main task</span></div><div class="line">    <a name="a10"></a><a class="code" href="../../dd/ddc/app__scheduler_8h.html#ab4edf0927cbbbf8e09ba6f59698b98f2">App_Scheduler_addTask</a>(advertiser_task, <a name="a11"></a><a class="code" href="../../dd/ddc/app__scheduler_8h.html#ae49a1abde6843cb44c37e47616d2a810">APP_SCHEDULER_SCHEDULE_ASAP</a>);</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="../../d2/dbd/data_8h.html#ad3aa19c96da7da312cd8fe99ea34554b">app_lib_data_receive_res_e</a> dataReceivedCb(</div><div class="line">    <span class="keyword">const</span> <a name="_a12"></a><a class="code" href="../../d2/dbd/data_8h.html#d7/df3/structapp__lib__data__received__t">app_lib_data_received_t</a> * data)</div><div class="line">{</div><div class="line">    uint8_t len = <span class="keyword">sizeof</span>(m_ack_data);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (len &gt; data-&gt;<a name="a13"></a><a class="code" href="../../d2/dbd/data_8h.html#af7dcc80b7a3cab03843f5bdff120f452">num_bytes</a>)</div><div class="line">    {</div><div class="line">        memset(m_ack_data, 0, len);</div><div class="line">        len = data-&gt;<a class="code" href="../../d2/dbd/data_8h.html#af7dcc80b7a3cab03843f5bdff120f452">num_bytes</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    memcpy(m_ack_data, data-&gt;<a name="a14"></a><a class="code" href="../../d2/dbd/data_8h.html#acc7ee0a7ec28292d2c1be47c4a23f78d">bytes</a>, len);</div><div class="line">    m_state.data[ACK].done = <span class="keyword">true</span>;</div><div class="line">    m_state.data[ACK].end_hp = (uint32_t) lib_time-&gt;getTimestampHp();</div><div class="line"></div><div class="line">    <a class="code" href="../../dd/ddc/app__scheduler_8h.html#ab4edf0927cbbbf8e09ba6f59698b98f2">App_Scheduler_addTask</a>(advertiser_task, <a class="code" href="../../dd/ddc/app__scheduler_8h.html#ae49a1abde6843cb44c37e47616d2a810">APP_SCHEDULER_SCHEDULE_ASAP</a>);</div><div class="line">    <span class="keywordflow">return</span> <a name="a15"></a><a class="code" href="../../d2/dbd/data_8h.html#ad3aa19c96da7da312cd8fe99ea34554ba5eb2a589b49f72b477f0cbf5deba552a">APP_LIB_DATA_RECEIVE_RES_HANDLED</a>;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> adv_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    memset(&amp;m_state, 0, <span class="keyword">sizeof</span>(m_state));</div><div class="line">    memset(&amp;m_beacons, 0, <span class="keyword">sizeof</span>(m_beacons));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> check_otap (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> ( lib_otap-&gt;isValid() &amp;&amp; \</div><div class="line">        !lib_otap-&gt;isProcessed() &amp;&amp; \</div><div class="line">        lib_otap-&gt;getSeq() == m_settings.otap_seq &amp;&amp; \</div><div class="line">        lib_otap-&gt;getProcessedSeq() != m_settings.otap_seq )</div><div class="line">        {</div><div class="line">            lib_otap-&gt;setToBeProcessed();</div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">        }</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> next_state(uint8_t next, uint32_t timeout_ms)</div><div class="line">{</div><div class="line">    adv_tag_state_data_t * state_data;</div><div class="line"></div><div class="line">    state_data = &amp;m_state.data[m_state.current];</div><div class="line">    state_data-&gt;done = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (m_state.current != ACK)</div><div class="line">    {</div><div class="line">        state_data-&gt;end_hp = (uint32_t) lib_time-&gt;getTimestampHp();</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (next == IDLE)</div><div class="line">    {</div><div class="line"></div><div class="line">        <span class="comment">/* Reset m_state to IDLE */</span></div><div class="line">        memset(&amp;m_state.data, 0, <span class="keyword">sizeof</span>(m_state.data));</div><div class="line">        memset(&amp;m_beacons, 0, <span class="keyword">sizeof</span>(m_beacons));</div><div class="line">        m_state.current = IDLE;</div><div class="line">        state_data = &amp;m_state.data[m_state.current];</div><div class="line">        state_data-&gt;start_hp = (uint32_t) lib_time-&gt;getTimestampHp();</div><div class="line">        state_data-&gt;done = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (m_state.run &gt; 0) <span class="comment">/*Another iteration requested*/</span></div><div class="line">        {</div><div class="line">           state_data-&gt;timeout_ms = <a class="code" href="../../dd/ddc/app__scheduler_8h.html#ae49a1abde6843cb44c37e47616d2a810">APP_SCHEDULER_SCHEDULE_ASAP</a>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span>  <span class="comment">/* Iteration completed */</span></div><div class="line">        {</div><div class="line">           state_data-&gt;timeout_ms = <a name="a16"></a><a class="code" href="../../dd/ddc/app__scheduler_8h.html#a52e39bcd9fb750ac5001e4e6b8de21c4">APP_SCHEDULER_STOP_TASK</a>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (next &lt; MAX_STATE)</div><div class="line">    {</div><div class="line">        m_state.current = next;</div><div class="line">        state_data = &amp;m_state.data[m_state.current];</div><div class="line">        state_data-&gt;start_hp = (uint32_t) lib_time-&gt;getTimestampHp();</div><div class="line">        state_data-&gt;timeout_ms = timeout_ms;</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> is_state_done(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span>  m_state.data[m_state.current].done;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> uint32_t state_timeout(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> m_state.data[m_state.current].timeout_ms;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> decode_ack(uint8_t * data)</div><div class="line">{</div><div class="line">    adv_tag_app_cfg_t * app_cfg = (adv_tag_app_cfg_t *) data;</div><div class="line"></div><div class="line">    <span class="comment">// update period; value 0 is invalid and ignored</span></div><div class="line">    <span class="keywordflow">if</span> (app_cfg-&gt;period != 0)</div><div class="line">     {</div><div class="line">        uint32_t period_ms = app_cfg-&gt;period * 1000;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (period_ms != m_settings.period_ms)</div><div class="line">        {</div><div class="line">            m_settings.period_phase_ms = <a name="a17"></a><a class="code" href="../../d1/d79/random_8h.html#af0ea379997d2ca169c89369620f788aa">Random_jitter</a>(period_ms);</div><div class="line">        }</div><div class="line">        m_settings.period_ms = period_ms;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//OTAP sequence</span></div><div class="line">    m_settings.otap_seq = app_cfg-&gt;otap_seq;</div><div class="line"></div><div class="line">    <span class="comment">// Maximum scan time; value 0 is invalid and ignored</span></div><div class="line">    <span class="keywordflow">if</span>( app_cfg-&gt;max_scan_time != 0 )</div><div class="line">    {</div><div class="line">        m_settings.max_scan_time_ms = app_cfg-&gt;max_scan_time * 10;</div><div class="line">    }</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> uint32_t rescan(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    m_beacons.retry++;</div><div class="line">    m_beacons.count = 0;</div><div class="line">    next_state(SCAN, TIMEOUT_SCAN_RETRY_MS);</div><div class="line">    memset(&amp;m_state.data[SCAN_END], 0, <span class="keyword">sizeof</span>(m_state.data[SCAN_END]));</div><div class="line">    memset(&amp;m_state.data[SEND_DATA], 0, <span class="keyword">sizeof</span>(m_state.data[SEND_DATA]));</div><div class="line">    memset(&amp;m_state.data[SEND_CONFIRM], 0, <span class="keyword">sizeof</span>(m_state.data[SEND_CONFIRM]));</div><div class="line">    memset(&amp;m_state.data[ACK], 0, <span class="keyword">sizeof</span>(m_state.data[ACK]));</div><div class="line">    <span class="keywordflow">return</span> state_timeout();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> uint32_t advertiser_task(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"></div><div class="line">    uint32_t delta_ms;</div><div class="line">    <span class="keywordtype">bool</span> timeout = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    delta_ms =  lib_time-&gt;getTimeDiffUs(lib_time-&gt;getTimestampHp(), \</div><div class="line">                            m_state.data[m_state.current].start_hp ) / 1000;</div><div class="line">    timeout = delta_ms + 20 &gt;= state_timeout();</div><div class="line">    <span class="keywordflow">if</span> (delta_ms &gt; 2*m_settings.period_ms)</div><div class="line">    {</div><div class="line">        delta_ms = m_settings.period_ms / 2;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">   <span class="keywordflow">switch</span>(m_state.current)</div><div class="line">   {</div><div class="line">       <span class="keywordflow">case</span> IDLE:</div><div class="line"></div><div class="line">            <span class="comment">/* From IDLE -&gt; SCAN after timeout */</span></div><div class="line">            m_state.run = 0;</div><div class="line">            uint32_t scan_delay = <a class="code" href="../../d1/d79/random_8h.html#af0ea379997d2ca169c89369620f788aa">Random_jitter</a>(SCAN_RAND_MS) + 50;</div><div class="line">            m_state.data[IDLE].done = <span class="keyword">true</span>;</div><div class="line">            m_state.tracking_id = (m_state.tracking_id == 65534) ? 1 : (m_state.tracking_id + 1);</div><div class="line">            next_state(SCAN, scan_delay);</div><div class="line"></div><div class="line"></div><div class="line">            <span class="keywordflow">return</span> state_timeout();</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">       <span class="keywordflow">case</span> SCAN:</div><div class="line">            lib_advertiser-&gt;scanOnAdvertiserBeacons(m_settings.max_scan_time_ms);</div><div class="line">            next_state(SCAN_END, TIMEOUT_SCAN_END_MS);</div><div class="line">            m_state.scan_count = m_state.scan_count &lt; 255 ? (m_state.scan_count + 1) : 255;</div><div class="line">            <span class="keywordflow">return</span> state_timeout();</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">       <span class="keywordflow">case</span> SCAN_END:</div><div class="line">            <span class="comment">/* Waiting for scan completion */</span></div><div class="line">            <span class="keywordflow">if</span>(is_state_done() || timeout )</div><div class="line">            {</div><div class="line">                <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;</div><div class="line">                <a class="code" href="../../db/d3b/state_8h.html#d7/dc8/structapp__lib__state__beacon__rx__t">app_lib_state_beacon_rx_t</a> * bp;</div><div class="line"></div><div class="line"></div><div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_beacons.count; i++)</div><div class="line">                {</div><div class="line">                    bp = &amp;m_beacons.data[i];</div><div class="line">                    <span class="keywordflow">if</span> (bp-&gt;<a name="a18"></a><a class="code" href="../../db/d3b/state_8h.html#a6149885080d7e0559447dcbccedcfe3b">is_sink</a>)</div><div class="line">                    {</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">else</span></div><div class="line">                    {</div><div class="line">                        success = <span class="keyword">true</span>;</div><div class="line">                        m_beacons.target = i;</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                    }</div><div class="line">                }</div><div class="line"></div><div class="line">                m_state.scan_failures = (m_beacons.count &gt; 0 &amp;&amp; success) ? 0 : (m_state.scan_failures + 1);</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (success)</div><div class="line">                {</div><div class="line">                    next_state(SEND_DATA, <a class="code" href="../../d1/d79/random_8h.html#af0ea379997d2ca169c89369620f788aa">Random_jitter</a>(SEND_RAND_MS));</div><div class="line">                    m_state.scan_failures = 0;</div><div class="line">                    <span class="keywordflow">return</span> state_timeout();</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                    <span class="comment">// scan failure is incremented when no beacons</span></div><div class="line">                    <span class="comment">// found | only sinks available</span></div><div class="line">                    <span class="keywordflow">if</span> (m_state.scan_failures &lt; MAX_SCAN_FAILURES)</div><div class="line">                    {</div><div class="line">                          m_state.scan_failures++;</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">if</span>(m_beacons.retry &lt; MAX_SCAN_RETRY</div><div class="line">                        &amp;&amp; m_state.scan_failures &lt; MAX_SCAN_FAILURES)</div><div class="line">                    {</div><div class="line">                        <span class="keywordflow">return</span> rescan();</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">            timeout = <span class="keyword">true</span>;  <span class="comment">// scan failed; we go to idle</span></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">       <span class="keywordflow">case</span> SEND_DATA:</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (m_beacons.count &gt; 0)</div><div class="line">            {</div><div class="line">                <a class="code" href="../../db/d3b/state_8h.html#d7/dc8/structapp__lib__state__beacon__rx__t">app_lib_state_beacon_rx_t</a> * bp =</div><div class="line">                    &amp;m_beacons.data[m_beacons.target];</div><div class="line">                <a class="code" href="../../d2/dbd/data_8h.html#ab53b6510f8ecb4a1621c905c15855164">app_lib_data_send_res_e</a> res;</div><div class="line">                adv_tag_data_t data;</div><div class="line"></div><div class="line">                m_state.send_count = m_state.send_count &lt; 255 ? (m_state.send_count + 1) : 255;</div><div class="line">                data.type = ADV_TYPE0;</div><div class="line">                data.<a name="a19"></a><a class="code" href="../../d2/dbd/data_8h.html#a3b962e67ba74725bd60ca3c29f785abe">rssi</a> = bp-&gt;<a name="a20"></a><a class="code" href="../../db/d3b/state_8h.html#ac4ea00add191a3290e428c5fdc838d1f">rssi</a>;</div><div class="line">                data.seq = m_state.tracking_id;</div><div class="line">                data.voltage = lib_hw-&gt;readSupplyVoltage();</div><div class="line">                data.proc_otap_seq = (uint8_t) lib_otap-&gt;getProcessedSeq();</div><div class="line">                data.stored_otap_seq = (uint8_t) lib_otap-&gt;getSeq();</div><div class="line">                data.scan_count = m_state.scan_count;</div><div class="line">                data.send_count = m_state.send_count;</div><div class="line"></div><div class="line">                m_adv_to_send.<a name="a21"></a><a class="code" href="../../d2/dbd/data_8h.html#acc7ee0a7ec28292d2c1be47c4a23f78d">bytes</a> = (uint8_t*) &amp;data;</div><div class="line">                m_adv_to_send.<a class="code" href="../../d2/dbd/data_8h.html#abe388560a25c7690c48b6f3e20a32278">dest_address</a> = bp-&gt;<a name="a22"></a><a class="code" href="../../db/d3b/state_8h.html#adeb8e3ced78abf9ec8931cd0d7a2d2c0">address</a>;</div><div class="line">                m_adv_to_send.<a name="a23"></a><a class="code" href="../../d2/dbd/data_8h.html#af7dcc80b7a3cab03843f5bdff120f452">num_bytes</a> = <span class="keyword">sizeof</span>(data);</div><div class="line">                m_adv_to_send.<a name="a24"></a><a class="code" href="../../d2/dbd/data_8h.html#a7f43082a8111a69a9189426ea4fb9987">tracking_id</a> = m_state.tracking_id;</div><div class="line"></div><div class="line">                res = lib_data-&gt;sendData(&amp;m_adv_to_send);</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (res == <a name="a25"></a><a class="code" href="../../d2/dbd/data_8h.html#ab53b6510f8ecb4a1621c905c15855164acf63322bd1c34794b230e2120116cfbb">APP_LIB_DATA_SEND_RES_SUCCESS</a>)</div><div class="line">                {</div><div class="line">                    next_state(SEND_CONFIRM, TIMEOUT_SEND_CONFIRM_MS);</div><div class="line">                    <span class="keywordflow">return</span> state_timeout();</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_beacons.retry &lt; MAX_SCAN_RETRY &amp;&amp;</div><div class="line">                        m_state.scan_failures &lt; MAX_SCAN_FAILURES &amp;&amp;</div><div class="line">                        m_state.send_count &lt; MAX_SEND_RETRY)</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">return</span> rescan();</div><div class="line">                }</div><div class="line"></div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">/*We did not found any m_beacons || data sent failed -&gt; force a timeout and move to IDLE */</span></div><div class="line">            timeout = <span class="keyword">true</span>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">       <span class="keywordflow">case</span> SEND_CONFIRM:</div><div class="line"></div><div class="line">             <span class="keywordflow">if</span>(is_state_done())</div><div class="line">             {</div><div class="line">                <span class="keywordflow">if</span> (m_state.data[SEND_CONFIRM].success  &amp;&amp;</div><div class="line">                    m_state.data[ACK].done)   <span class="comment">/*if ACK is not received yet we wait for ACK*/</span></div><div class="line">                {</div><div class="line">                    decode_ack(m_ack_data);</div><div class="line">                    next_state(IDLE, 0);</div><div class="line">                    m_state.scan_count = 0;</div><div class="line">                    m_state.send_count = 0;</div><div class="line">                    <span class="keywordflow">return</span> state_timeout();</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!m_state.data[SEND_CONFIRM].success &amp;&amp;    <span class="comment">/* send failure will trigger a retry*/</span></div><div class="line">                        m_beacons.retry &lt; MAX_SCAN_RETRY &amp;&amp;</div><div class="line">                        m_state.scan_failures &lt; MAX_SCAN_FAILURES &amp;&amp;</div><div class="line">                        m_state.send_count &lt; MAX_SEND_RETRY)</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">return</span> rescan();</div><div class="line">                }</div><div class="line">             }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (!timeout)</div><div class="line">             {</div><div class="line">                <span class="keywordflow">return</span> delta_ms;</div><div class="line">             }</div><div class="line"></div><div class="line">             <span class="keywordflow">break</span>;</div><div class="line">       <span class="keywordflow">default</span>:</div><div class="line">          <span class="comment">/* Is and error if we reached this state -&gt; force a timeout and move to IDLE */</span></div><div class="line">          timeout = <span class="keyword">true</span>;</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (timeout)</div><div class="line">   {</div><div class="line">        next_state(IDLE, 0);</div><div class="line">        <span class="keywordflow">return</span> state_timeout();</div><div class="line">   }</div><div class="line">   <span class="keywordflow">else</span></div><div class="line">   {</div><div class="line">        <span class="keywordflow">return</span> delta_ms;</div><div class="line">   }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> beaconReceivedCb(<span class="keyword">const</span> <a class="code" href="../../db/d3b/state_8h.html#d7/dc8/structapp__lib__state__beacon__rx__t">app_lib_state_beacon_rx_t</a> * beacon)</div><div class="line">{</div><div class="line">    uint8_t idx = m_beacons.count;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(idx &gt;= MAX_BEACONS || beacon-&gt; is_sink)</div><div class="line">    {</div><div class="line">     <span class="keywordflow">return</span>;  <span class="comment">//buffer is full or we found a sink</span></div><div class="line">    }</div><div class="line"></div><div class="line">    memcpy(&amp;m_beacons.data[idx], beacon, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d3b/state_8h.html#d7/dc8/structapp__lib__state__beacon__rx__t">app_lib_state_beacon_rx_t</a>));</div><div class="line">    m_beacons.time_hp[idx] = (uint32_t) lib_time-&gt;getTimestampHp();</div><div class="line">    m_beacons.count++;</div><div class="line">    <span class="keywordflow">if</span> (m_beacons.count &gt;= m_settings.max_beacons)</div><div class="line">    {</div><div class="line">        lib_advertiser-&gt;scanOffAdvertiserBeacons();</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> scanEndCb(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    m_state.data[SCAN_END].done = <span class="keyword">true</span>;</div><div class="line">    <a class="code" href="../../dd/ddc/app__scheduler_8h.html#ab4edf0927cbbbf8e09ba6f59698b98f2">App_Scheduler_addTask</a>(advertiser_task, <a class="code" href="../../dd/ddc/app__scheduler_8h.html#ae49a1abde6843cb44c37e47616d2a810">APP_SCHEDULER_SCHEDULE_ASAP</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> uint32_t main_task(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (m_state.run &lt; 255)</div><div class="line">    {</div><div class="line">        m_state.run++;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (m_state.current == IDLE)</div><div class="line">    {</div><div class="line">      <a class="code" href="../../dd/ddc/app__scheduler_8h.html#ab4edf0927cbbbf8e09ba6f59698b98f2">App_Scheduler_addTask</a>(advertiser_task, <a class="code" href="../../dd/ddc/app__scheduler_8h.html#ae49a1abde6843cb44c37e47616d2a810">APP_SCHEDULER_SCHEDULE_ASAP</a>);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_state.run &gt; 10)  <span class="comment">/*advertiser task run missed too many times*/</span></div><div class="line">    {</div><div class="line">       <a name="a26"></a><a class="code" href="../../dd/ddc/app__scheduler_8h.html#acd03212a86359f0f62d4953785087fd2">App_Scheduler_cancelTask</a>(advertiser_task);</div><div class="line">       next_state(IDLE, 0);  <span class="comment">//task will be started automatically next time</span></div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*OTAP */</span></div><div class="line">    <span class="keywordflow">if</span> (check_otap())</div><div class="line">    {</div><div class="line">        lib_state-&gt;stopStack();</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (m_settings.period_phase_ms == 0)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> m_settings.period_ms;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="comment">/*Re-adjust the phase when update period changed*/</span></div><div class="line">        uint32_t next_run_ms = m_settings.period_ms + m_settings.period_phase_ms;</div><div class="line">        m_settings.period_phase_ms = 0;</div><div class="line">        <span class="keywordflow">return</span> next_run_ms;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> callbacks_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">// Set periodic callback for sending advertisement/bcast messages</span></div><div class="line">    lib_state-&gt;setOnBeaconCb(beaconReceivedCb);</div><div class="line">    lib_advertiser-&gt;setScanEndCb(scanEndCb);</div><div class="line">    lib_data-&gt;setDataReceivedCb(dataReceivedCb);</div><div class="line">    lib_data-&gt;setDataSentCb(sentDataCb);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> node_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   <a class="code" href="../../d2/d39/app_8h.html#ad019ddac3feea21ca0548bced1c9e501">app_addr_t</a> node_addr = <a name="a27"></a><a class="code" href="../../df/d2e/node__configuration_8h.html#a445f5127c4f9e8f7e3ffd4694fedaf30">getUniqueAddress</a>();</div><div class="line">   <a class="code" href="../../de/d60/settings_8h.html#a69db270642a7b444986c801131fcbd66">app_lib_settings_net_addr_t</a> network_addr = NETWORK_ADDRESS;</div><div class="line">   <a class="code" href="../../de/d60/settings_8h.html#af0559e67154ec6b6dc9c34ccad540861">app_lib_settings_net_channel_t</a> network_ch = NETWORK_CHANNEL;</div><div class="line">   <span class="keywordtype">bool</span> ret = <span class="keyword">true</span>;</div><div class="line"></div><div class="line"><span class="preprocessor">#define USE_UICR_CONFIG</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_UICR_CONFIG</span></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">        UICR register are read</span></div><div class="line"><span class="comment">    */</span></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (lib_settings-&gt;getNodeAddress(&amp;node_addr) != <a name="a28"></a><a class="code" href="../../d2/d39/app_8h.html#a4d380466f2a9f6432a6abcabf44c8e80a003dcdf43ec0474fb1190cdccd959122">APP_RES_OK</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">// Node ID : CUSTOMER[0]</span></div><div class="line">        node_addr = (<a name="a29"></a><a class="code" href="../../d2/d39/app_8h.html#ad019ddac3feea21ca0548bced1c9e501">app_addr_t</a>) (NRF_UICR-&gt;CUSTOMER[0] &amp; 0xFFFFFF);</div><div class="line">        <span class="keywordflow">if</span> (node_addr == 0xFFFFFF)</div><div class="line">        {</div><div class="line">            node_addr = <a class="code" href="../../df/d2e/node__configuration_8h.html#a445f5127c4f9e8f7e3ffd4694fedaf30">getUniqueAddress</a>();</div><div class="line">        }</div><div class="line">        <span class="comment">// Network ID : CUSTOMER[1]</span></div><div class="line">        network_addr = (<a name="a30"></a><a class="code" href="../../de/d60/settings_8h.html#a69db270642a7b444986c801131fcbd66">app_lib_settings_net_addr_t</a>) (NRF_UICR-&gt;CUSTOMER[1] &amp; 0xFFFFFF);</div><div class="line">        <span class="keywordflow">if</span> (network_addr == 0xFFFFFF)</div><div class="line">        {</div><div class="line">            network_addr = NETWORK_ADDRESS;</div><div class="line">        }</div><div class="line">        <span class="comment">//Network channel : CUSTOMER[2]</span></div><div class="line">        <a class="code" href="../../de/d60/settings_8h.html#af0559e67154ec6b6dc9c34ccad540861">app_lib_settings_net_channel_t</a> network_ch = (<a name="a31"></a><a class="code" href="../../de/d60/settings_8h.html#af0559e67154ec6b6dc9c34ccad540861">app_lib_settings_net_channel_t</a>) (NRF_UICR-&gt;CUSTOMER[2] &amp; 0xFF);</div><div class="line">        <span class="keywordflow">if</span> (network_ch == 0xFF)</div><div class="line">        {</div><div class="line">            network_ch = NETWORK_CHANNEL;</div><div class="line">        }</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef FORCE_NETWORK_CONFIG</span></div><div class="line">    <span class="comment">/*  !!! Don&#39;t activate this unless in special use case !!!</span></div><div class="line"><span class="comment">        Default network address &amp; channel applied always</span></div><div class="line"><span class="comment">        Node address is preserved if exists</span></div><div class="line"><span class="comment">    */</span></div><div class="line">     <a class="code" href="../../d2/d39/app_8h.html#ad019ddac3feea21ca0548bced1c9e501">app_addr_t</a> prev_node_addr;</div><div class="line"></div><div class="line">     <span class="keywordflow">if</span> (lib_settings-&gt;getNodeAddress(&amp;prev_node_addr) != <a class="code" href="../../d2/d39/app_8h.html#a4d380466f2a9f6432a6abcabf44c8e80a003dcdf43ec0474fb1190cdccd959122">APP_RES_OK</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">// Not set</span></div><div class="line">        <span class="keywordflow">if</span> (lib_settings-&gt;setNodeAddress(node_addr) != <a class="code" href="../../d2/d39/app_8h.html#a4d380466f2a9f6432a6abcabf44c8e80a003dcdf43ec0474fb1190cdccd959122">APP_RES_OK</a>)</div><div class="line">       {</div><div class="line">           ret = <span class="keyword">false</span>;</div><div class="line">       }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (lib_settings-&gt;setNetworkAddress(NETWORK_ADDRESS) != <a class="code" href="../../d2/d39/app_8h.html#a4d380466f2a9f6432a6abcabf44c8e80a003dcdf43ec0474fb1190cdccd959122">APP_RES_OK</a>)</div><div class="line">    {</div><div class="line">        ret = <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    (void) network_ch;</div><div class="line">       <span class="keywordflow">if</span> (lib_settings-&gt;setNetworkChannel(NETWORK_CHANNEL) != <a class="code" href="../../d2/d39/app_8h.html#a4d380466f2a9f6432a6abcabf44c8e80a003dcdf43ec0474fb1190cdccd959122">APP_RES_OK</a>)</div><div class="line">    {</div><div class="line">        ret = <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="comment">// Settings are applied only when do not exist</span></div><div class="line">    <span class="keywordflow">if</span> (<a name="a32"></a><a class="code" href="../../df/d2e/node__configuration_8h.html#a1814777eb4e2f9906b0bed022de9e966">configureNode</a>(node_addr,</div><div class="line">                      network_addr,</div><div class="line">                      network_ch) != <a class="code" href="../../d2/d39/app_8h.html#a4d380466f2a9f6432a6abcabf44c8e80a003dcdf43ec0474fb1190cdccd959122">APP_RES_OK</a>)</div><div class="line">    {</div><div class="line">        ret = <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">        Role is always enforced to NODE_DEFAULT_ROLE i.e. directed-advertiser</span></div><div class="line"><span class="comment">        If role is changed reboot is needed</span></div><div class="line"><span class="comment">    */</span></div><div class="line"></div><div class="line">    <a class="code" href="../../de/d60/settings_8h.html#a6e80e9f924c933ad9e52603b56a3f82a">app_lib_settings_role_t</a> prev_node_role;</div><div class="line">    <span class="keywordflow">if</span> ((lib_settings-&gt;getNodeRole(&amp;prev_node_role) != <a class="code" href="../../d2/d39/app_8h.html#a4d380466f2a9f6432a6abcabf44c8e80a003dcdf43ec0474fb1190cdccd959122">APP_RES_OK</a>) || (prev_node_role!= NODE_DEFAULT_ROLE))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (lib_settings-&gt;setNodeRole(NODE_DEFAULT_ROLE) != <a class="code" href="../../d2/d39/app_8h.html#a4d380466f2a9f6432a6abcabf44c8e80a003dcdf43ec0474fb1190cdccd959122">APP_RES_OK</a>)</div><div class="line">        {</div><div class="line">        }</div><div class="line">         <span class="comment">//reboot is needed when the role is changed to directed-advertiser</span></div><div class="line">        ret = <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Set TTL to 30 ms</span></div><div class="line">    lib_advertiser-&gt;setQueuingTimeHp(30);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> App_init(<span class="keyword">const</span> <a name="_a33"></a><a class="code" href="../../d2/d39/app_8h.html#d6/d81/structapp__global__functions__t">app_global_functions_t</a> * functions)</div><div class="line">{</div><div class="line"></div><div class="line">    adv_init();</div><div class="line">    next_state(IDLE, 0);</div><div class="line">    <a name="a34"></a><a class="code" href="../../dd/ddc/app__scheduler_8h.html#aadb275bc1de9c05d677ab56117535802">App_Scheduler_init</a>();</div><div class="line">    <a name="a35"></a><a class="code" href="../../d1/d79/random_8h.html#ad1037d691a7e03c5ed05b601a01faffa">Random_init</a>(<a class="code" href="../../df/d2e/node__configuration_8h.html#a445f5127c4f9e8f7e3ffd4694fedaf30">getUniqueAddress</a>());</div><div class="line">    uint32_t delay = m_settings.period_ms + <a class="code" href="../../d1/d79/random_8h.html#af0ea379997d2ca169c89369620f788aa">Random_jitter</a>(m_settings.period_ms);</div><div class="line">    <a class="code" href="../../dd/ddc/app__scheduler_8h.html#ab4edf0927cbbbf8e09ba6f59698b98f2">App_Scheduler_addTask</a>(main_task, delay) ;</div><div class="line">    callbacks_init();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(node_init())</div><div class="line">    {</div><div class="line">        lib_state-&gt;startStack();</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        lib_state-&gt;stopStack();</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Mar 20 2020 11:53:36 for Wirepas Single-MCU SDK by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
